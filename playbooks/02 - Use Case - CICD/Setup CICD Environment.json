{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "Setup CICD Environment",
    "aliasName": null,
    "tag": null,
    "description": "Update the SVT of Change Management module as per the environment selected in CICD Configuration wizard",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "environment"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/4c58fed3-9e16-451a-9528-0be2b71acda4",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/e3243c1a-daf7-4bf1-901a-8cc380e797f2",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "cicd_config": "{% set env = [] %}{% for item in vars.request.selectedEnv.picklist %}{% set _ = env.append({\"itemValue\": item.itemValue, \"@id\": item[\"@id\"]}) %}{% endfor %}{\"env_config\": {{env}}, \"source_control\": {{vars.request.sourceControl}}}",
                "setup_record_list": "[\"Setup the Source Control for Production Environment\", \"Setup the Development Environment\"]",
                "source_control_operations": "[\"{{vars.request.sourceControl.label}}-CreateRepository\",\n\"{{vars.request.sourceControl.label}}-UpdateRemoteRepository\",\n\"{{vars.request.sourceControl.label}}-UpdateIssue\",\n\"{{vars.request.sourceControl.label}}-PushChanges\",\n\"{{vars.request.sourceControl.label}}-MergePullRequest\",\n\"{{vars.request.sourceControl.label}}-ListRepositoryIssue\",\n\"{{vars.request.sourceControl.label}}-ListRepositoryCollaborator\",\n\"{{vars.request.sourceControl.label}}-ListPullRequest\",\n\"{{vars.request.sourceControl.label}}-ListPullRequestReviews\",\n\"{{vars.request.sourceControl.label}}-FetchRelease\",\n\"{{vars.request.sourceControl.label}}-DeleteBranch\",\n\"{{vars.request.sourceControl.label}}-CreateUpdateFileContent\",\n\"{{vars.request.sourceControl.label}}-CreateRelease\",\n\"{{vars.request.sourceControl.label}}-CreatePullRequest\",\n\"{{vars.request.sourceControl.label}}-CreateIssue\",\n\"{{vars.request.sourceControl.label}}-CreateIssueComment\",\n\"{{vars.request.sourceControl.label}}-CreateBranch\",\n\"{{vars.request.sourceControl.label}}-CloneRepository\",\n\"{{vars.request.sourceControl.label}}-PullRequestAddReviewers\",\n\"{{vars.request.sourceControl.label}}-AddRepositoryCollaborator\",\n\"{{vars.request.sourceControl.label}}-AddPullRequestReview\", \"{{vars.request.sourceControl.label}}-GetServerURL\" ]"
            },
            "status": null,
            "top": "165",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "72d4a7bd-82d9-45ce-8092-de138c20189b"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create CICD Env Global Variable",
            "description": null,
            "arguments": {
                "params": {
                    "macro": "cicd_env",
                    "value": "{{vars.cicd_config | toJSON}}"
                },
                "version": "3.2.6",
                "connector": "cyops_utilities",
                "operation": "updatemacro",
                "operationTitle": "FSR: Create\/Update Global Variables",
                "step_variables": []
            },
            "status": null,
            "top": "1380",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "813442f4-8ab0-4a86-9af4-515fb8dc8985"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create CICD FSR Environment",
            "description": null,
            "arguments": {
                "resource": {
                    "key": "CICD FortiSOAR Environment",
                    "value": "{{(vars.cicd_config.env_config | json_query(\"[].itemValue\")) | join(\",\")}}",
                    "__replace": "true"
                },
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/keys",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "1110",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "cdec3fcb-a5f8-48e3-9e4f-20c7db7fc3ca"
        },
        {
            "@type": "WorkflowStep",
            "name": "Fetch CICD FSR Environment",
            "description": null,
            "arguments": {
                "query": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": [
                        {
                            "type": "primitive",
                            "field": "key",
                            "value": "CICD FortiSOAR Environment",
                            "operator": "eq",
                            "_operator": "eq"
                        }
                    ]
                },
                "module": "keys?$limit=30",
                "step_variables": []
            },
            "status": null,
            "top": "300",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928770",
            "group": null,
            "uuid": "990d0bbb-f29c-40cf-89d4-2c51dfb5c771"
        },
        {
            "@type": "WorkflowStep",
            "name": "Find Setup Environment",
            "description": null,
            "arguments": {
                "query": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": [
                        {
                            "type": "primitive",
                            "field": "title",
                            "value": "{{vars.setup_record_list}}",
                            "operator": "in",
                            "_operator": "in"
                        }
                    ]
                },
                "module": "change_management?$limit=30",
                "step_variables": []
            },
            "status": null,
            "top": "435",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928770",
            "group": null,
            "uuid": "0aded246-f9d5-48f2-829c-37952fe60070"
        },
        {
            "@type": "WorkflowStep",
            "name": "Get Source Control Workflows",
            "description": null,
            "arguments": {
                "params": {
                    "query": "{\n    \"sort\": [\n        {\n            \"field\": \"createDate\",\n            \"direction\": \"DESC\",\n            \"_fieldName\": \"createDate\"\n        }\n    ],\n    \"limit\": 90,\n    \"logic\": \"AND\",\n    \"filters\": [\n        {\n            \"field\": \"recordTags\",\n            \"value\": [\"{{vars.item}}\"],\n            \"display\": \"\",\n            \"operator\": \"in\",\n            \"type\": \"array\",\n            \"OPERATOR_KEY\": \"$\"\n        },\n        {\n            \"field\": \"isActive\",\n            \"value\": true,\n            \"operator\": \"eq\"\n        }\n    ],\n    \"__selectFields\": [\n        \"id\", \"name\", \"recordTags\"\n    ]\n}",
                    "resource": "workflows"
                },
                "version": "3.2.6",
                "for_each": {
                    "item": "{{vars.source_control_operations}}",
                    "parallel": false,
                    "condition": ""
                },
                "connector": "cyops_utilities",
                "operation": "query_cyops_resource",
                "operationTitle": "FSR: Find Record",
                "step_variables": {
                    "cicd_config": "{%set temp = {}%}{%set result = {}%}{% for i in vars.steps.Get_Source_Control_Workflows %}{% set result = {}%}{% for tag in i[\"data\"][0][\"recordTags\"] %}{% if '-' in tag %}{% set m = result.update({\"tag\": tag.split(\"-\")[-1]})%}{% endif %}\n{% endfor %}{% set a = temp.update({result[\"tag\"]: {\"name\": i[\"data\"][0][\"name\"],\"@id\": i[\"data\"][0][\"@id\"]}}) %}{% endfor %}{% set dummy = result.update({\"source_control_playbooks\": temp})%}{{result}}",
                    "activeWorkflows": "{{vars.result.data|json_query(\"[][\\\"@id\\\"][]\")}}"
                }
            },
            "status": null,
            "top": "1240",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "b688e2d8-9214-4196-9952-5f623d8637eb"
        },
        {
            "@type": "WorkflowStep",
            "name": "Is CICD FSR Environment Record Exist",
            "description": null,
            "arguments": {
                "conditions": [
                    {
                        "option": "Update CICD FSR Environment Record",
                        "step_iri": "\/api\/3\/workflow_steps\/fc5e29ce-eb4e-4ce6-aca7-d0fe193df395",
                        "condition": "{{ vars.steps.Fetch_CICD_FSR_Environment | length > 0 }}",
                        "step_name": "Update CICD FSR Environment Record"
                    },
                    {
                        "option": "Update CICD FSR Environment Record",
                        "default": true,
                        "step_iri": "\/api\/3\/workflow_steps\/cdec3fcb-a5f8-48e3-9e4f-20c7db7fc3ca",
                        "step_name": "Create CICD FSR Environment"
                    }
                ],
                "step_variables": []
            },
            "status": null,
            "top": "975",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/12254cf5-5db7-4b1a-8cb1-3af081924b28",
            "group": null,
            "uuid": "7e0149cf-6ae4-4ccf-b5b8-633b0ec881f3"
        },
        {
            "@type": "WorkflowStep",
            "name": "Set Default Environment Type",
            "description": null,
            "arguments": {
                "for_each": {
                    "item": "{{vars.steps.Find_Setup_Environment}}",
                    "__bulk": true,
                    "parallel": false,
                    "condition": "",
                    "batch_size": 100
                },
                "resource": {
                    "type": "\/api\/3\/picklists\/b43deb65-1edc-482b-b20e-1fed06bbc01c",
                    "__link": {
                        "recordTags": []
                    },
                    "environment": "{% if \"Production\" in vars.item.title %}{{\"Change Management Environment\" | picklist(\"Production\", \"@id\")}}{% else %}{{\"Change Management Environment\" | picklist(\"Development\", \"@id\")}}{% endif %}"
                },
                "operation": "Append",
                "collection": "{{vars.item[\"@id\"]}}",
                "__recommend": [],
                "collectionType": "\/api\/3\/change_management",
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "990eb8db-3c12-4144-bcda-9ba15717e849"
        },
        {
            "@type": "WorkflowStep",
            "name": "Set Setup Environment",
            "description": null,
            "arguments": {
                "setup_type": "{% if vars.cicd_config.env_config | length == 2 %}{{vars.steps.Set_Default_Environment_Type | json_query(\"[? environment.itemValue == 'Development']\")}}{% else %}{% for setup in vars.steps.Set_Default_Environment_Type %}{% if setup.environment.itemValue in vars.cicd_config.env_config[0].itemValue %}{{vars.steps.Set_Default_Environment_Type | json_query(\"[? environment.itemValue != '\"+vars.cicd_config.env_config[0].itemValue+\"']\")}}{% endif %}{% endfor %}{% endif %}"
            },
            "status": null,
            "top": "705",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "559b2359-c7ca-40e3-8acc-06ff977dfad0"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    }
                }
            },
            "status": null,
            "top": "30",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "e3243c1a-daf7-4bf1-901a-8cc380e797f2"
        },
        {
            "@type": "WorkflowStep",
            "name": "Update CICD FSR Environment Record",
            "description": null,
            "arguments": {
                "resource": {
                    "value": "{{(vars.cicd_config.env_config | json_query(\"[].itemValue\")) | join(\",\")}}"
                },
                "operation": "Append",
                "collection": "{{vars.steps.Fetch_CICD_FSR_Environment[0]['@id']}}",
                "__recommend": [],
                "collectionType": "\/api\/3\/keys",
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "1110",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "fc5e29ce-eb4e-4ce6-aca7-d0fe193df395"
        },
        {
            "@type": "WorkflowStep",
            "name": "Update Setup Environment",
            "description": null,
            "arguments": {
                "resource": {
                    "environment": "\/api\/3\/picklists\/5ec65649-9da5-4fcd-8198-48dcb548cf41"
                },
                "operation": "Append",
                "collection": "{{vars.setup_type[0][\"@id\"]}}",
                "__recommend": [],
                "collectionType": "\/api\/3\/change_management",
                "fieldOperation": [],
                "step_variables": []
            },
            "status": null,
            "top": "840",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928722",
            "group": null,
            "uuid": "b0ab255f-5db5-41f2-be7e-10f2160e850b"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Fetch CICD FSR Environment",
            "targetStep": "\/api\/3\/workflow_steps\/990d0bbb-f29c-40cf-89d4-2c51dfb5c771",
            "sourceStep": "\/api\/3\/workflow_steps\/72d4a7bd-82d9-45ce-8092-de138c20189b",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "7bf0fb04-71c5-4d10-9f2f-c3e43b98dfea"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Create CICD FSR Environment -> Get Source Control Workflows",
            "targetStep": "\/api\/3\/workflow_steps\/b688e2d8-9214-4196-9952-5f623d8637eb",
            "sourceStep": "\/api\/3\/workflow_steps\/cdec3fcb-a5f8-48e3-9e4f-20c7db7fc3ca",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "2b0fe6ea-e948-4e65-8026-f3ef01bfd60a"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Fetch CICD FSR Environment -> Find Setup Environment",
            "targetStep": "\/api\/3\/workflow_steps\/0aded246-f9d5-48f2-829c-37952fe60070",
            "sourceStep": "\/api\/3\/workflow_steps\/990d0bbb-f29c-40cf-89d4-2c51dfb5c771",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "be59c71c-3acc-4cbb-8025-4547b851f120"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Find Setup Environment -> Set Default Environment Type",
            "targetStep": "\/api\/3\/workflow_steps\/990eb8db-3c12-4144-bcda-9ba15717e849",
            "sourceStep": "\/api\/3\/workflow_steps\/0aded246-f9d5-48f2-829c-37952fe60070",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "0c7c72a3-fc8f-4d2f-b01f-2474ab37f98d"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Get Source Control Workflows -> Create CICD Env Global Variable",
            "targetStep": "\/api\/3\/workflow_steps\/813442f4-8ab0-4a86-9af4-515fb8dc8985",
            "sourceStep": "\/api\/3\/workflow_steps\/b688e2d8-9214-4196-9952-5f623d8637eb",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "afefa7ec-5173-4799-9e14-fc1abf97385c"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Is CICD FSR Environment Record Exist -> Create CICD FSR Environment",
            "targetStep": "\/api\/3\/workflow_steps\/cdec3fcb-a5f8-48e3-9e4f-20c7db7fc3ca",
            "sourceStep": "\/api\/3\/workflow_steps\/7e0149cf-6ae4-4ccf-b5b8-633b0ec881f3",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "9ee44c89-3c73-4e23-966d-c84128c0ee76"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Is CICD FSR Environment Record Exist -> Update CICD FSR Environment Record",
            "targetStep": "\/api\/3\/workflow_steps\/fc5e29ce-eb4e-4ce6-aca7-d0fe193df395",
            "sourceStep": "\/api\/3\/workflow_steps\/7e0149cf-6ae4-4ccf-b5b8-633b0ec881f3",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "585d0d5f-34e8-4771-a37e-bf5f8648706d"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Set Default Environment Type -> Set Setup Environment",
            "targetStep": "\/api\/3\/workflow_steps\/559b2359-c7ca-40e3-8acc-06ff977dfad0",
            "sourceStep": "\/api\/3\/workflow_steps\/990eb8db-3c12-4144-bcda-9ba15717e849",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "efb9c530-26ce-43e3-b5c0-56e88c229e4d"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Set Setup Environment -> Update Setup Environment",
            "targetStep": "\/api\/3\/workflow_steps\/b0ab255f-5db5-41f2-be7e-10f2160e850b",
            "sourceStep": "\/api\/3\/workflow_steps\/559b2359-c7ca-40e3-8acc-06ff977dfad0",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "0676cb97-55b0-43b8-bd15-ee91b67ebe72"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/72d4a7bd-82d9-45ce-8092-de138c20189b",
            "sourceStep": "\/api\/3\/workflow_steps\/e3243c1a-daf7-4bf1-901a-8cc380e797f2",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "feb73928-b8b8-49fb-9304-1cd96ddbcdf0"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update CICD FSR Environment Record -> Get Source Control Workflows",
            "targetStep": "\/api\/3\/workflow_steps\/b688e2d8-9214-4196-9952-5f623d8637eb",
            "sourceStep": "\/api\/3\/workflow_steps\/fc5e29ce-eb4e-4ce6-aca7-d0fe193df395",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "d76652da-b750-45dd-9924-e74a75a5f82d"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update Setup Environment -> Is CICD FSR Environment Record Exist",
            "targetStep": "\/api\/3\/workflow_steps\/7e0149cf-6ae4-4ccf-b5b8-633b0ec881f3",
            "sourceStep": "\/api\/3\/workflow_steps\/b0ab255f-5db5-41f2-be7e-10f2160e850b",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "2106dfa4-7cb7-4960-ab18-99f22e701085"
        }
    ],
    "groups": [],
    "priority": "\/api\/3\/picklists\/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
    "uuid": "936a5236-e7ca-4c44-b3cf-cce8937df365",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "CICD",
        "Wizard"
    ]
}